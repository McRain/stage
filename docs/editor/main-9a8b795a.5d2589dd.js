"use strict";(self.webpackChunk_reneos_3d_editor=self.webpackChunk_reneos_3d_editor||[]).push([[415],{1291:(e,t,a)=>{e.exports=a.p+"assets/76bf5ab841899c419d06.svg"},2950:(e,t,a)=>{a.d(t,{A:()=>g});var n=a(5421);const s={class:"app-container canvas-container"},o={class:"workspace"},i={id:"editorcanvas",ref:"editorcanvas"},r={id:"playcanvas",ref:"playcanvas"},c={id:"playui",ref:"playui"},l={key:0,class:"splash"};var d=a(7378),p=a(3822),u=a(3842),m=a(9216);const h={data:()=>({selectedElement:null,loadComponent:"div",modulesLoaded:!1,progress:0}),computed:{ui(){return this.$app.ui},hierarhyAllow(){return this.$app.engine.instances.length>0},options(){return this.$app.options},app(){return this.$app.app},tools:()=>toolse,models(){return this.$app.models},ready(){return this.$app.app.ready},toasts(){return this.$app.toasts},modal(){return this.$app.modal},translations(){return this.$app.translations}},methods:{async start(){this.$app.app.ready=!0},waitCanvasSize(e){const t=window.devicePixelRatio||1;e.forEach(e=>{e.width=e.clientWidth*t,e.height=e.clientHeight*t})}},async mounted(){document.documentElement.setAttribute("data-theme","dark"),window.THREE=u,await this.$app.app.init(),await this.$app.modules.init();const e=this.$refs.editorcanvas,t=this.$refs.playcanvas;this.waitCanvasSize([e,t]);const a=["actions","assets","models","modules","project","slides"],n=new URLSearchParams(window.location.search);let s;switch(n.get("src")){case"db":default:this.$app.project.uid=n.get("db")||"editor",await m.A.Init(this.$app.project.uid,a,"uid");const e=[];for(let t=0;t<a.length;t++){const n=await m.A.getAllItems(a[t]);e.push(n)}const[t=[],o=[],i=[],r=[],c={uid:this.$app.project.uid},l=[]]=e;s={actions:t,assets:o,models:i,modules:r,project:c,slides:l};break;case"url":const d=await fetch(n.get("url"));s=await d.json(),this.$app.project.uid=s.project.uid,await m.A.Init(this.$app.project.uid,a,"uid")}this.$app.project.init(s.project),await new Promise(e=>{this.$nextTick(e)}),this.loadComponent="LoaderScreen",await this.$app.engine.load(),await this.$app.modules.loadUserModules(s.modules),this.progress=10,await Promise.all([this.$app.assets.init(s.assets,e=>{this.progress+=e}),this.$app.actions.init(s.actions)]),this.$app.engine.Project.Init(t),this.$app.engine.Project.Start(),this.progress=70,await p.A.Init(e),await this.$app.engine.start();const o=this.$app.engine.CssManager;await o.Init(this.$refs.playui,t),this.$app.project.on("create",e=>{o.OnCreate(e,this.$app.ui,this.$app.slides)}),await this.$app.project.load(s.models),this.progress=80,await this.$app.slides.load(s.slides),this.progress=90,s.slides.length>0&&this.$app.slides.goto(0),this.progress=100,this.app.ready=!0},components:{UI:d.A}},g=(0,a(6262).A)(h,[["render",function(e,t,a,d,p,u){const m=(0,n.resolveComponent)("UI"),h=(0,n.resolveComponent)("Modal"),g=(0,n.resolveComponent)("Toasts");return(0,n.openBlock)(),(0,n.createElementBlock)("div",s,[(0,n.createElementVNode)("div",o,[(0,n.createElementVNode)("canvas",i,null,512),(0,n.createElementVNode)("canvas",r,null,512),(0,n.createElementVNode)("div",c,[((0,n.openBlock)(!0),(0,n.createElementBlock)(n.Fragment,null,(0,n.renderList)(u.ui.elements,(e,t)=>((0,n.openBlock)(),(0,n.createBlock)((0,n.resolveDynamicComponent)(e.component),(0,n.mergeProps)({onMounted:u.ui.onElementMount,key:t},(0,n.toHandlers)(e.events||{}),{ref_for:!0},e.data),null,16,["onMounted"]))),128))],512),(0,n.createVNode)(m,{element:p.selectedElement},null,8,["element"])]),u.ready?(0,n.createCommentVNode)("v-if",!0):((0,n.openBlock)(),(0,n.createElementBlock)("div",l,[((0,n.openBlock)(),(0,n.createBlock)((0,n.resolveDynamicComponent)(p.loadComponent),{loadingProgress:p.progress,onClick:u.start},null,8,["loadingProgress","onClick"]))])),u.modal.isVisible?((0,n.openBlock)(),(0,n.createBlock)(h,{key:1})):(0,n.createCommentVNode)("v-if",!0),(0,n.createVNode)(g)])}]])},4594:(e,t,a)=>{a.r(t),a.d(t,{actions:()=>R,app:()=>X,assets:()=>W,engine:()=>S,inspector:()=>je,menu:()=>ke,modal:()=>m,modules:()=>A,project:()=>ce,projects:()=>Re,selection:()=>He,slides:()=>we,storage:()=>Ue,templates:()=>ze,toasts:()=>d,ui:()=>Xe});var n=a(5421),s=a(9216),o=a(2320),i=a(4196),r=a(8092);let c=0;const l=(0,n.reactive)({list:[],add({message:e,icon:t,onclick:a,timehide:s=!0,type:o,...i},d=(0,n.markRaw)(r.A)){const p=(0,n.reactive)({id:c++,data:{message:e,icon:t,type:o,...i},component:d});return s&&(p.timeout=setTimeout(()=>{l.remove(p.id)},3e3)),p.onclick=a||l.remove.bind(this,p.id),l.list.push(p),p},remove(e){for(let t=l.list.length-1;t>=0;t--)l.list[t].id===e&&l.list.splice(t,1)}}),d=l,p=(0,n.ref)(!1),u=(0,n.reactive)({isVisible:!1,header:null,content:null,footer:null,values:null,open({header:e,content:t,footer:a,...n}){u.header=e||{},u.content=t||{},u.footer=a||{},u.values={closable:!1,...n},p.value=!0},close(e){e||(p.value=!1)},get isVisible(){return p.value},queryText(e,t,a){u.open({header:{value:e.title,handler:u.close},content:{component:"queryform",props:e,events:{"update:text":a}},footer:{buttons:[...t.map(t=>(t.handler=()=>{t.callback(e.answer),u.close()},t)),{label:"Закрыть",class:"additional",handler:u.close}]}})},confirmReq(e,t){u.open({header:{value:e.title,handler:u.close},content:{component:"confirmform",props:e},footer:{buttons:[...t.map(t=>(t.handler=()=>{t.callback(e.answer),u.close()},t))]}})}}),m=u,h=o.default||o;class g extends Error{constructor(){super("Not all required parameters are specified."),this.isReqError=!0}}const w=[{name:"engine",entry:"/editor/engine/mf.js",index:"engine"},{name:"tools",entry:"/mods/tools/mf.js",index:"tools"},{name:"gsapmod",entry:"/mods/gsap/mf.js",index:"gsap"},{name:"troika",entry:"/mods/troika/mf.js",index:"troika"}],f=[],y={};function v(){const e=(0,n.reactive)({selected:null,list:f,processed:!1}),t={label:"Save",class:"secondary",hidden:(0,n.computed)(()=>!e.selected||e.processed),handler:async()=>{e.processed=!0;try{e.selected=await async function(e){console.log(e);const t={...e};if(!e.name?.length||!e.index?.length||!e.entry?.length)throw new g;if(!e.uid)try{(0,i.registerRemotes)([e]),await(0,i.loadRemote)(`${e.name}/${e.index}`)}catch(e){throw e}await async function(e){await s.A.upsertItemProperties("modules",e.index,{id:e.index,uid:e.index,...e})}(t);const a={module:e,name:e.name,index:e.index,entry:e.entry};return f.push(a),a}(e.selected)}catch(t){return console.log(t),t.isReqError?d.add({message:"Not all required fields are filled in"}):d.add({message:"Error adding module"}),void(e.processed=!1)}d.add({message:"The module has been loaded successfully."})}},a={label:"Registration",class:"secondary",hidden:(0,n.computed)(()=>e.selected),handler:()=>{e.selected=(0,n.reactive)({name:"",entry:"",index:""})}},o={label:"Close",class:"primary",handler:async()=>{m.close()}},r=(0,n.reactive)([a,t,o]);m.open({header:{value:"Managing modules",handler:()=>{m.close()}},content:{component:"ItemsLib",props:e,events:{selected:t=>e.selected=t},slots:{edit:{component:"ModuleEdit",props:e,events:{edit:(t,a)=>{console.log(t,a),e.selected[t]=a}}}}},footer:{buttons:r}})}const b=(0,n.reactive)({init:async function(){f.length=0,await(0,i.registerRemotes)([...w]),await Promise.all(w.map(e=>new Promise(t=>{(0,i.loadRemote)(`${e.name}/${e.index}`).then(a=>{y[e.name]=a,t()})})))},showLib:v,getMod:function(e){return y[e]},loadUserModules:async function(e){console.log("LoadUserModules"),await(0,i.registerRemotes)(e);const t=e.map(e=>(console.log(e),new Promise(t=>{(0,i.loadRemote)(`${e.name}/${e.index}`).then(a=>{f.push({module:a,name:e.name,index:e.index,entry:e.entry}),t()})})));await Promise.all(t),console.log(`UserModules loaded ${t.length}`)}});h.On("init",()=>{h.menu.hierarhy.list.push({icon:"books",tooltip:"Modules",handler:v}),window.vue.component("ModuleEdit",(0,n.defineAsyncComponent)(async()=>{const e=await a.e(440).then(a.bind(a,440));return e.default||e}))});const A=b;let j;const x={},E=[],I=[],M=(0,n.reactive)({ready:!1,getAssetsManager:()=>x.AssetsManager,getSlidesManager:()=>x.SlidesManager,getFactory:()=>x.Factory,getManager:e=>x[e]||j,async load(){console.log("Engine load");const{AssetsManager:e,CssManager:t,MouseManager:a,ActionsManager:n,Project:s,SlidesManager:o,Factory:i}=A.getMod("engine");x.AssetsManager=e,x.SlidesManager=o,x.Factory=i,x.MouseManager=a,x.ActionsManager=n,x.CssManager=t,x.Project=j=s,console.log("Engine load complete"),console.log(I);const r=[];for(let e=0;e<I.length;e++)r.push(I[e](j));I.length=0,await Promise.all(r)},async start(){M.ready=!0;const e=[];for(let t=0;t<E.length;t++)e.push(E[t](j));return E.length=0,await Promise.all(e),console.log(j),j},onload(e){E.push(e)},onInit(e){I.push(e)}}),S=new Proxy(M,{get:(e,t)=>t in e?e[t]:x[t]});var k=a(540);const $=o.default||o,C=[];let P;function F(e){const t=(0,n.reactive)({selected:null,list:T.list}),a={label:"Close",class:"secondary",handler:async()=>{t.selected=null,m.close(),e&&e()}},o=(0,n.reactive)({label:"Create",class:"primary",handler:async()=>{const e=T.library[0];t.selected={type:e.component,group:e.type,targets:["*"],description:e.description,...e.template}}}),i=(0,n.reactive)({label:"Cancel",class:"additional",hidden:(0,n.computed)(()=>!t.selected||t.selected.uid),handler:async()=>{t.selected=null}}),r={label:"Save",class:"primary",hidden:(0,n.computed)(()=>!t.selected||t.selected.uid),handler:async()=>{const e=T.library.find(e=>e.component===t.selected.type);if(e.check){if(!await e.check(t.selected))return void d.add({message:"Неверные параметры"})}else Object.keys(e.template).forEach(a=>{a in t.selected||(t.selected[a]=JSON.parse(JSON.stringify(e.template[a])))});t.selected.uid=`${t.selected.type}${Date.now()}`,T.list.push(t.selected),await O(t.selected),await P.Add(t.selected)}},c={label:"Удалить",class:"additional",hidden:(0,n.computed)(()=>!t.selected||!t.selected.uid),handler:async()=>{const e=T.list.findIndex(e=>e===t.selected);e>=0&&T.list.splice(e,1),async function(e){await s.A.deleteItem("actions",e)}(t.selected.uid),t.selected=null}},l={label:"Select",class:"additional",hidden:(0,n.computed)(()=>!t.selected||!t.selected.uid||!e),handler:async()=>{e(t.selected),m.close()}},p=(0,n.reactive)([o,r,l,c,i,a]);m.open({header:{value:e?"Выберите действие":"Библиотека действий",handler:()=>{m.close()}},content:{component:"ItemsLib",props:t,events:{selected:e=>{e.uid&&(console.log(e),t.selected=e)}},slots:{item:{component:"ActionItem"},edit:{component:"ActionEdit",props:{selected:t.selected},events:{"change:type":e=>{const a=T.library.find(t=>t.component===e);t.selected={...a.template,type:a.component,group:a.type,description:a.description}},edit:(e,a)=>{const n=e.split(".");let s=t.selected;for(let e=0;e<n.length-1;e++){const t=n[e];s[t]||(s[t]={}),s=s[t]}s[n[n.length-1]]=a,O(t.selected)}}}}},footer:{buttons:p}})}async function O(e){e.uid&&await s.A.upsertItemProperties("actions",e.uid,JSON.parse(JSON.stringify({id:e.uid,...e})))}const T=(0,n.reactive)({init:async function(e){0===e.length&&e.push(...C),T.list.length=0,P=S.ActionsManager;const t=(0,n.reactive)(e);await P.Init(t),T.list.push(...P.Library)},register:function(e){T.library.push(e)},save:O,showLib:F,exportData:async function(){return await s.A.getAllItems("actions")},removeFrom:async function(e,{hook:t,uid:a}){},hooks:["enable.on","slide.in.before","slide.in","slide.in.after","slide.out.before","slide.out","slide.out.after","disable.on","mouse.in","mouse.click","mouse.out"],list:[],library:[],get groups(){return T.library.reduce((e,t)=>(e.includes(t.type)||e.push(t.type),e),[])},get values(){return Object.values(T.list)}});$.On("init",()=>{$.menu.hierarhy.list.push({icon:"history",tooltip:"Action Library",handler:F}),window.vue.component("ActionsList",k.A),$.inspector.addToModels(["Object3D"],[{label:"Models actions",readonly:!0,content:{prop:"actions",component:"ActionsList",state:!1}},{label:"States actions",readonly:!0,content:{prop:"actions",component:"ActionsList",state:!0}}])});const R=T;var L=a(1187),H=a(3437);const D=o.default||o,N={asset:[{label:"URL",content:{prop:"url",component:"LabelEdit",async onupdate(e,t,a,n){await U.Update(e,t,a)}}},{label:"Clone",head:{component:"BoolEdit",prop:"clone",async onupdate(e,t,a,n){await U.Update(e,t,a)}}}],gltf:[{label:"Shadow",content:{component:"ShadowEdit",prop:"shadow",onupdate:async(e,t,a,n)=>{await U.Update(e,t,a)}}},{label:"Environment map",inspectorOnly:!0,content:{component:"AssetSelector",prop:"envMap",type:"hdr",onupdate:async(e,t,a,n)=>{await U.Update(e,t,a)}}}],texture:[{label:"Image",content:{inspectorOnly:!0,prop:"img",component:"ImageView",props:{acceptedTypes:"image/*"},async onupdate(e,t,a){console.log(t),e.img=t}}}],hdr:[]},B={gltf:()=>!0};let U;function J(e=[]){return G.list.filter(t=>0===e.length||e.includes(t.type)).map(e=>({...e.data}))}async function q(e){e.uid=`asset_${Date.now()}`;const t=U.Add(e);await t.load(),G.list.push(t),await s.A.addItem("assets",JSON.parse(JSON.stringify({id:t.uid,...t.data})))}async function V(e){console.log("Save asset");try{if(!e.uid)return;await s.A.updateItem("assets",JSON.parse(JSON.stringify({id:e.uid,...e.data})))}catch(e){console.error("Error saving asset:",e),D.toasts.add({message:"Error saving asset"})}}async function _(e){switch(e.type){case"gltf":const t=S.getFactory().CheckUseAsset(e.uid);if(t)return D.toasts.add({message:`Cannot delete, asset is used in ${t} models`}),!1;break;case"hdr":if(G.list.find(t=>t.data.envMap===e.uid))return D.toasts.add({message:"Cannot delete, asset in use"}),!1}const t=G.list.findIndex(t=>t.uid===e.uid);return t>=0&&(G.list.splice(t,1),U.Remove(e.uid),await s.A.deleteItem("assets",e.uid)),!0}function z(e,t=!0){return new Promise(a=>{const s=(0,n.reactive)({selected:null,list:J(e)}),o=(0,n.reactive)([{label:"Select",class:"primary",hidden:(0,n.computed)(()=>!t||!s.selected),handler:async()=>{m.close(),a(s.selected)}},{label:"Remove",class:"additional",hidden:(0,n.computed)(()=>!s.selected?.uid),handler:async()=>{_(s.selected)&&(s.selected=null,s.list=J(e))}},{label:"Save",class:"primary",hidden:(0,n.computed)(()=>!s.selected||s.selected.uid||s.busy),handler:async()=>{if(!B[s.selected.type]||await B[s.selected.type](s.selected)){D.toasts.add({message:"Start load asset"});try{await q(s.selected)}catch(e){return D.toasts.add({message:e.message}),void(s.selected.uid=null)}s.list=J(e),D.toasts.add({message:"Asset saved"})}}},{label:"Create",class:"secondary",handler:async()=>{s.selected={name:"",type:G.types[0],url:""}}},{label:"Close",class:"additional",handler:async()=>{m.close(),a()}}]);m.open({header:{value:t?"Select asset":"Project assets",handler:()=>{m.close()}},content:{component:"ItemsLib",props:s,events:{selected:e=>{s.selected=e}},slots:{edit:{component:"AssetEdit",props:{selected:s.selected},events:{edit:(e,t)=>{s.selected[e]=t,s.selected.uid&&V({data:s.selected})}}}}},footer:{buttons:o}})})}const G=(0,n.reactive)({init:async function(e,t){console.log("Init assets"),U=S.getManager("AssetsManager"),await U.Init(e,t);const a=Array.from(U.Assets.values());a.forEach(e=>{e.on("update",()=>{V(e)})}),G.list.push(...a)},create:q,update:async function(e,t,a){await U.Update(e,t,a)},save:V,selectAsset:z,editAsset:function(e){const t=(0,n.reactive)({current:e}),a=(0,n.reactive)([{label:"Save",class:"secondary",handler:async()=>{e.uid?await V({data:e}):await q(e),m.close()}},{label:"Cancel",class:"primary",handler:async()=>{m.close()}}]);m.open({header:{value:"Select asset",handler:()=>{m.close()}},content:{component:"AssetEdit",props:t,events:{edit:(t,a)=>{e[t]=a}}},footer:{buttons:a}})},remove:_,setAsset:function(e,t){e.assets||(e.assets=[]),e.assets.push({uid:t.uid}),D.engine.getFactory().AddAsset(e.uid,t)},types:["gltf","hdr","texture"],list:[],exportData:async()=>await s.A.getAllItems("assets"),get inspector(){return N},getInspector:e=>N[e]||[],async getDefault(){const e=await fetch("https://s3.eu-west-1.amazonaws.com/3dbuilder.reneos.com/base/assets.json"),t=await e.json();return await s.A.upsertMany("assets",t,"uid"),t}});D.On("init",()=>{D.menu.hierarhy.list.push({icon:"cube",tooltip:"Assets library",handler:()=>{z([],!1)}}),window.vue.component("AssetSelector",L.A),window.vue.component("AssetEdit",H.A),Object.keys(N).forEach(e=>{D.inspector.addToModels([e],N[e])})});const W=G;a(1109);const Z=o.default||o,X=(0,n.reactive)({save:async function(){const e={uid:"currproject",id:"currproject",actions:R.exportData(),assets:W.exportData(),elements:Elements.exportData()};return await s.A.updateItem("projects",e),e.uid},draggedNode:null,ready:!1,cameras:[],get types(){return Z.engine.getFactory().GetTypes()},user:{registered:!1,name:"Guest",options:{manual:"false"!==localStorage.getItem("options.manual")}},setPassword:async function(e){try{const{error:t,me:a}=await gqlc.Set({me:[{password:[{$args:{value:e}}]}]})}catch(e){Z.toasts.add({message:"Error on change password"})}},async logout(){const e=await fetch("/auth/logout"),t=await e.json();console.log(t),window.location.reload()},async init(){}});var Y=a(3822),K=a(351),Q=a(6667),ee=a(9338);const te=o.default||o,ae=new K.A;let ne;async function se(e,t,a){if(!t)return;if(a[t.uid])return a[t.uid];const n=t.parent;let s=a[n];s||(s=await se(e,e.find(e=>e.uid===n),a));const o=await oe(t,s);return a[o.uid]=o,o}async function oe(e,t){const a=await ne.BuildElement(e,t||te.engine.getManager().Root);if(!a)return;a.name=e.name||e.uid,a.states=e.states||{},a.properties=e.properties||{},a.actions=e.actions||[],a.paths=e.paths??a.paths,a.path=a.paths.join(".");const s=(0,n.reactive)(a);return(t||re).add(s),ae.emit("create",s),s}function ie(e,t,a=[]){for(let n=0;n<e.length;n++){const s=e[n];s.isElement&&s.states[t]&&a.push(s),s.children||console.warn("No child"),s.children.length&&ie(s.children,t,a)}}const re=(0,n.reactive)({add(e){re.children.push(e)},uid:null,init:function(e){re.info=e.find(e=>"info"===e.uid)||{name:"Editor"}},info:{name:"Editor"},load:async function(e){ne=te.engine.getFactory();const t={};for(let a=e.length-1;a>=0;a--){const n=e[a],s=await se(e,n,t),o=e.findIndex(e=>e.uid===s.uid);o>=0&&e.splice(o,1)}},findStates:function(e){const t=[];return ie(re.children,e,t),t},getState:function(e,t){return e.states[t]||(e.states[t]={actions:[]},ae.emit("stateadd",t,e.paths)),e.states[t]},remove:async function e(t){let a=re,n=re;for(let e=0;e<t.length;e++)a=n,n=a.children.find(a=>a.uid===t[e]);te.selection.selected===n&&te.selection.select(null);const o=a.children.findIndex(e=>e===n);if(o>=0){for(let t=0;t<n.children.length;t++){const a=n.children[t];a.isElement&&e(a.paths)}a.children.splice(o,1),n.parent&&n.parent.remove(n),s.A.deleteItem("models",n.uid),ne.RemoveModel(n.uid),ae.emit("remove",t)}},handleAsset:async function(e){if(te.slides.actived){if("gltf"===e.source.type){console.log("gltf");const t=`${e.source.name||e.source.uid}${Date.now()}`.replace(".",""),a=await te.project.createElement({type:"Object3D",uid:t,parent:e.target?.uid,assets:[{uid:e.source.uid}],paths:[...e.target?.paths||[],t]},e.target);await te.project.save(a),te.selection.select(a)}}else te.toasts.add({message:"Необходимо создать слайд"})},createElement:oe,save:async function(e){try{await s.A.upsertItemProperties("models",e.uid,JSON.parse((0,ee.As)({name:e.name,paths:e.paths,path:e.paths.join("."),parent:e.parent?.uid||null,actions:e.actions||[],props:e.props||{},properties:e.properties||{},states:e.states,type:e.type,uid:e.uid,assets:e.assets||[]})))}catch(e){console.warn(e)}},find:function(e){let t=re;for(let a=0;a<e.length;a++)t=t.children.find(t=>t.uid===e[a]);return t},findObjectsByType:function(e){const t=[];return function a(n){n instanceof e&&t.push(n.data),n.children&&Array.isArray(n.children)&&n.children.forEach(e=>a(e))}(re),t},exportToJson:async function(){const e=await s.A.exportToJson(re.uid),t=new Blob([JSON.stringify(e)],{type:"application/json"}),a=`project${re.uid}.json`;if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveBlob(t,a);else{const e=window.document.createElement("a");e.href=window.URL.createObjectURL(t),e.download=a,e.style="display: none",e.click()}},importProject:async function(){try{const e=await function(e=".json"){return new Promise(t=>{const a=document.createElement("input");a.type="file",a.accept=e,a.style.display="none",a.addEventListener("change",()=>{a.files&&a.files[0]&&t(a.files[0]),document.body.removeChild(a)}),document.body.appendChild(a),a.click()})}(),t=await function(e){return new Promise((t,a)=>{if(!e.name.endsWith(".json"))return void a(new Error("Выберите файл с расширением .json"));const n=new FileReader;n.onload=e=>{try{const a=JSON.parse(e.target.result);t(a)}catch(e){a(new Error("Ошибка парсинга JSON: "+e.message))}},n.onerror=()=>{a(new Error("Ошибка чтения файла"))},n.readAsText(e)})}(e);(0,n.reactive)({actions:{},assets:{},elements:{},slides:{},modules:{}}),await s.A.addItems("actions",t.actions),await s.A.addItems("assets",t.assets),await s.A.addItems("models",t.models),await s.A.addItems("slides",t.slides),await s.A.addItems("modules",t.modules),await s.A.addItems("project",t.project);const a=new URL(window.location.href);return window.location.href=a.toString(),t}catch(e){throw console.error("Ошибка:",e.message),e}},play:async function(e="data"){const t=await s.A.exportToJson(re.uid);console.log(t),t.project={ui:{slides:!0,fullscreen:!0}};let a=`../player?src=${e}`;"db"===e&&(a+=`&db=${re.uid}`);const n=window.open(a,"Player");if(n){if("data"===e){const e=async(a=0)=>{try{if(n.closed)return void console.error("Окно плеера было закрыто");n.postMessage({type:"INIT_DATA",payload:t},window.location.origin)}catch(t){console.error("Ошибка при отправке данных:",t),a<5&&setTimeout(()=>e(a+1),500*(a+1))}};setTimeout(e,1e3)}}else console.error("Не удалось открыть окно. Возможно, браузер заблокировал pop-up.")},children:[],on:ae.on.bind(ae),off:ae.off.bind(ae),options:{camera:{}}});te.On("init",()=>{window.vue.component("Importer",Q.A),te.slides.on("change",e=>{ie(re.children,e,[])}),te.slides.on("remove",e=>{const t=[];ie(re.children,e,t);for(let a=0;a<t.length;a++)delete t[a].states[e]}),te.menu.addMenu("app",{path:"app.list.project",icon:"",text:"Project",link:"#",children:[{path:"app.list.project.create",icon:"file-empty",text:"Create",handler:async()=>{te.projects.create()}},{path:"app.list.project.open",icon:"menu",text:"Open",tooltip:"Open project",handler:()=>{te.projects.open()}},{path:"app.list.project.export",icon:"download",text:"Export",tooltip:"Export project",handler:()=>{te.project.exportToJson()}},{path:"app.list.project.import",icon:"upload",text:"Import",link:"#",tooltip:"Import project",handler:()=>{te.project.importProject()}},{path:"app.list.project.remove",icon:"bin",text:"Delete",handler:()=>{te.projects.remove()}}]})});const ce=re,le=o.default||o,de=new K.A;async function pe(e){const t=e||ge.actived,a={actions:t.actions,name:t.name,camera:t.camera,uid:t.uid,props:t.props},n=JSON.parse((0,ee.As)(a));try{await s.A.upsertItemProperties("slides",a.uid,n)}catch(e){console.warn(e)}}function ue(e){const t=ge.actived;ge.actived="number"==typeof e?ge.children[e]:ge.children.find(t=>t.uid===e),ge.actived&&(de.emit("change",ge.actived.uid),async function(e,t){let a=[],n=ce.findStates(e.uid);t&&(a=ce.findStates(t.uid),await async function(e,t,a){const n=[],s=[];for(let e=0;e<t.length;e++){const o=t[e];a.findIndex(e=>e.uid===o.uid)>=0?n.push(o):s.push(o)}const o=[...s,...n];await Promise.all([le.engine.ActionsManager.Execute(o,"slide.out"),le.engine.ActionsManager.Run(e.actions,e,"slide.out")]),await le.engine.ActionsManager.Execute(s,"disable.on");for(let e=0;e<s.length;e++)he(s[e])}(t,a,n)),await async function(e,t,a){const n=[],s=[];for(let e=0;e<t.length;e++){const o=t[e];a.findIndex(e=>e.uid===o.uid)>=0?s.push(o):n.push(o)}console.log("Slide In");try{if(e.camera?.path&&e.camera?.path!==le.engine.getManager().Camera?.path){const t=e.camera.path.split("."),a=ce.find(t);le.engine.getManager().SetCamera(a),a.updateProjectionMatrix()}console.log(e.background),e.background&&(e.background.isAsset?le.engine.getManager().Scene.background=e.background.resource:le.engine.getManager().Scene.background=e.background)}catch(e){console.warn(e.message)}const o=[...n,...s];await Promise.all([le.engine.ActionsManager.Execute(o.map(t=>({...t.states[e.uid],model:t})),"slide.in.before"),le.engine.ActionsManager.Run(e.actions,e,"slide.in.before")]),await le.engine.ActionsManager.Execute(n,"enable.on"),await Promise.all([le.engine.ActionsManager.Execute(o,"slide.in"),le.engine.ActionsManager.Run(e.actions,e,"slide.in")]);const i=[];for(let t=0;t<o.length;t++)i.push(me(o[t],e.uid));await Promise.all(i),await Promise.all([le.engine.ActionsManager.Execute(o,"slide.in.after"),le.engine.ActionsManager.Run(e.actions,e,"slide.in.after")])}(e,n,a)}(ge.actived,t))}async function me(e,t){const{position:a,rotation:n,scale:s,actions:o=[],properties:i={},...r}=e.states[t];a&&e.position.copy(a),n&&e.rotation.setFromVector3(n,"XYZ"),s&&e.scale.copy(s);const c=Object.keys(r).map(async t=>{const a=t.split("."),n=r[t];let s=a[0],o=e;try{for(let e=0;e<a.length-1;e++)o=o[a[e]],s=a[e+1];return o[s]=await le.engine.getFactory().CreateElement(n),{success:!0,key:t}}catch(e){return console.warn(e),{success:!1,key:t,error:e}}});await Promise.all(c),e.state=e.states[t]||{model:e};const l=le.engine.Factory.TreeTypes.find(t=>t.type===e.type);l?.onchange&&l.onchange(e)}function he(e,t){e.visible=!1}const ge=(0,n.reactive)({load:async function(e){ge.children.length=0;const t=e.sort((e,t)=>e.index-t.index);for(let e=0;e<t.length;e++){const a={name:"",children:[],camera:{path:null},actions:[],...t[e]};ge.children.push(a)}ce.on("remove",e=>{const t=e.join(".");le.engine.Project.Camera?.path===t&&le.engine.Project.ResetCamera();for(let e=0;e<ge.children.length;e++){const a=ge.children[e];a.camera?.path===t&&(a.camera.path=null,pe(a))}})},add:async function(e){const t=`sl${Date.now()}`,a={index:ge.children.length,name:t,uid:t,background:null,environment:{},camera:{path:null},props:{},actions:[],...e};return ge.children.push(a),await pe(a),de.emit("add",a.uid),a},remove:async function(e){console.log("remove");let t=e||ge.actived.uid;const a=ge.children.findIndex(e=>e.uid===t);if(a>=0){ge.actived.uid===t&&(0===a?await ue(1):await ue(a-1)),ge.children.splice(a,1),await s.A.deleteItem("slides",t);const e=ge.children.find(e=>e.next===t);e&&ge.children.length>=a&&(e.next=ge.children[a].uid),de.emit("remove",t)}},save:pe,actived:null,children:[],goto:ue,next(){const e=ge.children.findIndex(e=>e.uid===ge.actived.uid);e>=ge.children.length-1||ge.goto(e+1)},back(){const e=ge.children.findIndex(e=>e.uid===ge.actived.uid);0!==e&&ge.goto(e-1)},on:de.on.bind(de),off:de.off.bind(de)}),we=ge,fe=[],ye=[],ve={},be={Object3D:[{label:"Transform",readonly:!0,content:{component:"TransformEdit",state:!0}},{label:"Visibility",data:{},head:{prop:"visible",component:"BoolEdit",state:!0}},{label:"Shadow",content:{component:"ShadowEdit",prop:"shadow",state:!1,onupdate:async(e,t,a,n)=>{e.castShadow=a.cast||!1,e.receiveShadow=a.receive||!1}}}],DirectionalLight:[{label:"Color",head:{component:"EditColor",prop:"color",state:!0,onupdate(e,t,a,n){}}},{label:"Intensity",head:{component:"Float",prop:"intensity",step:.1,min:0}},{label:"Shadow",data:{},head:{prop:"castShadow",component:"BoolEdit"}}],AmbientLight:[{label:"Color",head:{component:"EditColor",prop:"color",state:!0,onupdate(e,t,a,n){e[t].copy(a);const s=e.states[we.actived.uid];s.properties||(s.properties={}),s.properties[t]={type:"Color",args:["#"+a.getHexString()]},ce.save(e)}}},{label:"Intensity",head:{component:"Float",prop:"intensity",step:.1,min:0,state:!0}}],Mesh:[{label:"Shadow",content:{component:"ShadowEdit",prop:"shadow",state:!1,onupdate:async(e,t,a,n)=>{e.castShadow=a.cast||!1,e.receiveShadow=a.receive||!1}}}],label2d:[{label:"Размеры",content:{component:"DimensionsEdit",onupdate(e,t,a,n){e[t]=a,ce.save(e)},state:!0}},{label:"Text",content:{prop:"text",component:"TextEdit",state:!0}},{label:"Цвет",head:{component:"TextColorEdit",prop:"color",state:!0}},{label:"Размер шрифта",head:{component:"FontSize",prop:"size",state:!0}}],videoplane:[{label:"URL",content:{component:"LabelEdit",prop:"url",state:!1,onupdate(e,t,a,n){e.properties||(e.properties={}),e.properties.url=a}},head:{component:"Label",prop:"url"}}],Camera:[{label:"Far",head:{prop:"far",component:"Float",onupdate(e,t,a,n){e[t]=e.states[we.actived.uid][t]=a,e.updateProjectionMatrix(),Y.A.CameraHelper.update(),ce.save(e)}}},{label:"Near",head:{prop:"near",component:"Float",state:!0,onupdate(e,t,a,n,s){e[t]=e.states[we.actived.uid][t]=a,e.updateProjectionMatrix(),Y.A.CameraHelper.update(),ce.save(e)}}}],PerspectiveCamera:[{label:"FOV",head:{prop:"fov",component:"Float",onupdate(e,t,a){e[t]=e.states[we.actived.uid][t]=a,e.updateProjectionMatrix(),Y.A.CameraHelper.update(),ce.save(e)}}}],OrthographicCamera:[{label:"Left",head:{prop:"left",component:"Float",onupdate(e,t,a){e[t]=e.states[we.actived.uid][t]=a,e.updateProjectionMatrix(),Y.A.CameraHelper.update(),ce.save(e)}}},{label:"Top",head:{prop:"top",component:"Float",onupdate(e,t,a){e[t]=e.states[we.actived.uid][t]=a,e.updateProjectionMatrix(),Y.A.CameraHelper.update(),ce.save(e)}}},{label:"Right",head:{prop:"right",component:"Float",onupdate(e,t,a){e[t]=e.states[we.actived.uid][t]=a,e.updateProjectionMatrix(),Y.A.CameraHelper.update(),ce.save(e)}}},{label:"Bottom",head:{prop:"bottom",component:"Float",onupdate(e,t,a){e[t]=e.states[we.actived.uid][t]=a,e.updateProjectionMatrix(),Y.A.CameraHelper.update(),ce.save(e)}}}]},Ae={},je=(0,n.reactive)({ready:!1,cameras:[],blocksFor:(e=["Object3D"])=>e.flatMap(e=>be[e]||[]),handlers:Ae,setHandler(e,t){Ae[e]=t},getHandlers:()=>Ae,addBlocks(e,t){Object.keys(_blocks).forEach(a=>{t(a)&&_blocks[a].push(...e)})},addToAssets(e,t){for(let a=0;a<e.length;a++){const n=e[a];"*"!==n?(ve[n]||(ve[n]=[]),ve[n].push(...t)):ye.push(...t)}},addToModels(e,t){for(let a=0;a<e.length;a++){const n=e[a];"*"!==n?(be[n]||(be[n]=[]),be[n].push(...t)):fe.push(...t)}}});var xe=a(5216);const Ee=o.default||o;function Ie(e){xe.A.Transformer.setMode(e)}function Me(e,t){e.children??=[],(t.children||[]).forEach(t=>{let a=e.children.find(e=>e.path===t.path);a?Me(a,t):e.children.push(t)})}const Se=(0,n.reactive)({addMenu:function(e,t){const a=Se[e].list.find(e=>e.path===t.path);a?Me(a,t):Se[e].list.push(t)},app:{list:[]},top:{list:[{icon:"sphere",hint:"Local/global space",handler:function(){xe.A.Transformer.setSpace("local"===xe.A.Transformer.space?"world":"local")}},{icon:"move",hint:"Moving",handler:Ie.bind(null,"translate")},{icon:"loop2",hint:"Rotation",handler:Ie.bind(null,"rotate")},{icon:"enlarge2",hint:"Scale",handler:Ie.bind(null,"scale")},{icon:"target",hint:"Zoom in on selected",handler:xe.A.FocusToSelect},{icon:"cross",hint:"Deselect",handler:()=>{Ee.selection.select(null)}}],options:{size:"1.5em"}},hierarhy:{list:[{icon:"play3",tooltip:"Run",handler:()=>{Ee.project.play()}}],options:{}},tools:{list:[]}}),ke=Se,$e=o.default||o,Ce=[];let Pe="";async function Fe(e){const t=new URL(window.location.href);t.searchParams.set("src","db"),t.searchParams.set("db",e),window.location.href=t.toString()}async function Oe(){const e=await s.A.GetFromAll("project","info");return Te.list.length=0,Te.list.push(...e.filter(e=>void 0!==e).map(e=>(e.uid=e.id,e))),Te.list}const Te=(0,n.reactive)({init:async function(e){console.log(e),Pe=e,await s.A.Init(e,["project","assets","models","slides","actions","modules"],"uid"),await Oe()},create:async function(){const e=(0,n.reactive)({title:"Создание проекта",text:"Укажите название проекта * ",answer:"",template:""}),t=(0,n.reactive)({label:"Создать",class:"primary",disabled:e.answer.length<1,callback:async e=>{const t=`project${Date.now()}`;await s.A.Create(t,{project:[{uid:"info",id:t,name:e,created:Date.now(),last:Date.now()}],assets:[],actions:[],models:[],slides:[],modules:[]}),Fe(t)}});m.queryText(e,[t],a=>{e.answer=a,t.disabled=e.answer.length<1})},open:async function(){const e=await Oe(),t=(0,n.reactive)({list:e.filter(e=>e.uid!==$e.project.uid)});m.open({header:{value:"Открыть проект",handler:m.close},content:{component:"ItemsLib",props:t,events:{selected:e=>{Fe(e.id),m.close()}},slots:{item:{component:"ProjectItem"}}},footer:{buttons:[{label:"Закрыть",class:"primary",handler:m.close}]}})},goto:Fe,remove:async function(e){const t=e||Pe;await s.A.DeleteDatabase(t);const a=Te.list.findIndex(e=>e.uid===t);a>=0&&Te.list.splice(a,1);const n=new URL(`${window.location.origin}${window.location.pathname}`);window.location.href=n.toString()},getList:Oe,loadExample:async function(e){const t=(await Ce[e]()).default,a=`project${e}`;await s.A.Init(a,["project","assets","models","slides","actions","modules"],"uid"),await s.A.addItems("actions",t.actions),await s.A.addItems("assets",t.assets),await s.A.addItems("models",t.models),await s.A.addItems("modules",t.modules),await s.A.addItems("project",t.project),await s.A.addItems("slides",t.slides);const n=new URL(window.location.href);n.searchParams.set("project",a),window.location.href=n.toString()},play:async function(e="data"){const t=await s.A.exportToJson(Pe);console.log(t),t.project={ui:{slides:!0,fullscreen:!0}};let a=`../player?target=${e}`;"src"===e&&(a+=`&src=${Pe}`);const n=window.open(a,"Player");if(n){if("data"===e){const e=async(a=0)=>{try{if(n.closed)return void console.error("Окно плеера было закрыто");n.postMessage({type:"INIT_DATA",payload:t},window.location.origin),console.log("Данные отправлены")}catch(t){console.error("Ошибка при отправке данных:",t),a<5&&setTimeout(()=>e(a+1),500*(a+1))}};setTimeout(e,1e3)}}else console.error("Не удалось открыть окно. Возможно, браузер заблокировал pop-up.")},importProject:async function(){try{const e=await function(e=".json"){return new Promise(t=>{const a=document.createElement("input");a.type="file",a.accept=e,a.style.display="none",a.addEventListener("change",()=>{a.files&&a.files[0]&&t(a.files[0]),document.body.removeChild(a)}),document.body.appendChild(a),a.click()})}(),t=await function(e){return new Promise((t,a)=>{if(!e.name.endsWith(".json"))return void a(new Error("Выберите файл с расширением .json"));const n=new FileReader;n.onload=e=>{try{const a=JSON.parse(e.target.result);t(a)}catch(e){a(new Error("Ошибка парсинга JSON: "+e.message))}},n.onerror=()=>{a(new Error("Ошибка чтения файла"))},n.readAsText(e)})}(e);let a=!1;const o=(0,n.reactive)({actions:{},assets:{},elements:{},slides:{},modules:{}});return m.open({header:{value:"Импорт",handler:()=>{m.close()}},content:{component:"Importer",props:{project:t},events:{options:e=>{a=e.merge},changelist:e=>{Object.keys(e).forEach(t=>{o[t]=e[t]})}}},footer:{buttons:[{label:"Импорт",class:"secondary",handler:async()=>{const e=`project${Date.now()}`;await s.A.Init(e,["project","assets","elements","slides","actions","modules"],"uid"),await s.A.addItems("actions",t.actions),await s.A.addItems("assets",t.assets),await s.A.addItems("elements",t.elements),await s.A.addItems("slides",t.slides),await s.A.addItems("modules",t.modules),await s.A.addItems("project",t.project);const a=new URL(window.location.href);a.searchParams.set("project",e),window.location.href=a.toString(),m.close()}},{label:"Отмена",class:"primary",handler:async()=>{m.close()}}]}}),t}catch(e){throw console.error("Ошибка:",e.message),e}},load:async function(){},player:null,list:[]}),Re=Te,Le=(0,n.reactive)({uid:"",selected:null,slide:{},select(e){if(Le.selected=e,!Le.selected)return xe.A.Select(null),void(Le.uid=null);Le.uid=Le.selected.uid,e.isObject3D&&xe.A.Select(Le.selected)}}),He=Le,De=o.default||o,Ne=new class{#e=null;get handle(){return this.#e}async requestAccess(){this.#e=await window.showDirectoryPicker({mode:"readwrite"}),await s.A.upsertItemProperties("project","storage",{handle:this.#e})}updateHandle(e){this.#e=e}async writeFile(e,t){this.#t();const a=await this.#e.getFileHandle(e,{create:!0}),n=await a.createWritable();await n.write(t),await n.close()}async readFile(e){this.#t();const t=await this.#e.getFileHandle(e),a=await t.getFile();return await a.text()}async listFiles(){this.#t();const e=[];for await(const[t,a]of this.#e.entries())"file"===a.kind&&e.push(t);return e}#t(){if(!this.#e)throw new Error("Folder access not granted")}};let Be;const Ue=(0,n.reactive)({getHandle:()=>Ne.handle,init:async function(){const e=await s.A.getItem("project","storage");if(e)Ne.updateHandle(e.handle);else{const e=(0,n.reactive)({title:"Укажите папку для хранения моделей",text:"",answer:"",template:""}),t=(0,n.reactive)({label:"ОК",class:"primary",callback:async e=>{await Ne.requestAccess(),Be&&Be()}});De.modal.confirmReq(e,[t])}},requestAccess:Ne.requestAccess.bind(Ne),writeFile:Ne.writeFile.bind(Ne),readFile:Ne.readFile.bind(Ne),listFiles:Ne.listFiles.bind(Ne),access:()=>new Promise(e=>{Be=e})});var Je=a(8334),qe=a(2941);const Ve=o.default||o;const _e=(0,n.reactive)({preview:async function(e,t,a=0,n=100){console.log(a,n);try{const{error:s,templates:o}=await gqlc.Get({templates:[{$args:{theme:e,sort:t,skip:a,limit:n}},"uid","title","image","price","images",{autor:["name"]}]});if(s)throw new Error;return o}catch(e){Ve.toasts.add({message:e.message})}},load:async function(e){try{const{error:t,template:a}=await gqlc.Get({template:[{$args:{id:e}},"title","autor","image","assets","actions","models","modules","project","slides"]});if(t)throw new Error;return a}catch(e){Ve.toasts.add({message:""})}}});Ve.On("init",()=>{window.vue.component("TemplateItem",Je.A),window.vue.component("TemplateView",qe.A)});const ze=_e,Ge=o.default||o,We={},Ze=(0,n.reactive)({elements:[],onElementMount(e){We[e.path]&&(We[e.path](e.element),delete We[e.path])},addElement(e,t){return new Promise((a,s)=>{if(!window.vue._context.components[e])return Ge.toasts.add({message:`Component "${e}" is not registered`}),void s(new Error(`Component "${e}" is not registered`));const o=(0,n.reactive)(t.data);this.elements.push({component:e,data:o,events:t.events}),We[t.data.path]=e=>{a({data:o,element:e})}})}});Ge.On("init",()=>{Ze.elements.length=0});const Xe=Ze}}]);